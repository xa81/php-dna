name: Update all-dna repo

on:
  push:
    branches:
      - main

jobs:
  update-all-dna:
    if: github.repository == 'domainreseller/php-dna'
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout php-dna repo
        uses: actions/checkout@v3

      - name: Clone all dna repos
        run: |
          git clone https://github.com/domainreseller/hostbill-dna.git
          git clone https://github.com/domainreseller/whmcs-dna.git
          git clone https://github.com/domainreseller/wisecp-dna.git
          git clone https://github.com/domainreseller/blesta-dna.git
          git clone https://github.com/domainreseller/clientexec-dna
          git clone https://github.com/domainreseller/hostfact-dna
          git clone https://github.com/domainreseller/fossbilling-dna

      - name: Copy updated library files
        run: |
          SRC="DomainNameApi"
          EXTRA="DNASoap.php DNARest.php SharedApiConfigAndUtilsTrait.php"

          copy_lib() {
            local dir="$1" main="$2"
            cp "$SRC/DomainNameAPI_PHPLibrary.php" "$main"
            for f in $EXTRA; do cp "$SRC/$f" "$dir/$f"; done
          }

          copy_lib "hostbill-dna/includes/modules/Domain/domainnameapi/lib" "hostbill-dna/includes/modules/Domain/domainnameapi/lib/dna.php"
          copy_lib "blesta-dna/components/modules/domainnameapi/apis" "blesta-dna/components/modules/domainnameapi/apis/api.php"
          copy_lib "whmcs-dna/modules/registrars/domainnameapi/lib" "whmcs-dna/modules/registrars/domainnameapi/lib/dna.php"
          copy_lib "wisecp-dna/coremio/modules/Registrars/DomainNameAPI" "wisecp-dna/coremio/modules/Registrars/DomainNameAPI/api.php"
          copy_lib "clientexec-dna" "clientexec-dna/api.php"
          copy_lib "hostfact-dna/domainnameapi/library/DomainNameApi" "hostfact-dna/domainnameapi/library/DomainNameApi/DomainNameAPI_PHPLibrary.php"
          copy_lib "fossbilling-dna/library/Registrar/Adapter/DomainNameApi/lib" "fossbilling-dna/library/Registrar/Adapter/DomainNameApi/lib/dna.php"



      - name: Commit and push changes
        env:
          PAT: ${{ secrets.HOSTBILL_DNA_PAT }}
        run: |
          for repo in hostbill-dna whmcs-dna blesta-dna wisecp-dna clientexec-dna hostfact-dna fossbilling-dna; do
            cd $repo
            git config user.name "DomainNameApi"
            git config user.email "info@domainnameapi.com"
            git remote set-url origin https://domainreseller:${PAT}@github.com/domainreseller/$repo.git
            git add .
            git commit -m "Automatic Update Library from php-dna repo" || echo "No changes to commit in $repo"
            git push origin master || git push origin main
            cd ..
          done
